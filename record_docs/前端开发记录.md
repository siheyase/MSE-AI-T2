
# Streamlitå‰ç«¯-å¼€å‘è®°å½•

**è´Ÿè´£æˆå‘˜ï¼šè™å¥ç¿”ã€è”¡å­£å¦**

MedRAGå‰ç«¯æ”¯æŒç—…ä¾‹ç”Ÿæˆä¸ä¸‹è½½ã€æ¨¡å‹é€‰æ‹©ã€å¯¹è¯å†å²ç®¡ç†ã€PDFå¯¼å‡ºã€Sessionå¤šè½®ç®¡ç†ç­‰åŠŸèƒ½ã€‚

## æŠ€æœ¯æ ˆä¸ä¾èµ–

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **Streamlit** | æ„å»ºå‰ç«¯äº¤äº’ç•Œé¢ |
| **Agentic RAG æ¶æ„** | æ”¯æŒé•¿å¯¹è¯ä¸å·¥å…·è°ƒç”¨çš„ LLM ç®¡ç†æ–¹å¼ |
| **WeasyPrint** | Markdown è½¬ PDF æŠ¥å‘Šç”Ÿæˆ |
| **markdown2** | Markdown è§£æ |
| **nest_asyncio** | æ”¯æŒå¼‚æ­¥äº‹ä»¶åµŒå¥—ï¼ˆé€‚ç”¨äº Streamlitï¼‰ |
| **requests** | ä¸åç«¯äº¤äº’ç”Ÿæˆç—…ä¾‹æŠ¥å‘Š |
| **agno.document.reader** | å¤šæ ¼å¼æ–‡æ¡£åŠ è½½ï¼ˆPDFã€CSVã€TXTã€ç½‘é¡µï¼‰ |
| **SQLite3** | ä¼šè¯å†å²è®°å½•æŒä¹…åŒ–å­˜å‚¨ï¼ˆDBè·¯å¾„ä¸º `history/case.db`ï¼‰ |

## ç³»ç»ŸåŠŸèƒ½æ¨¡å—

### 1. é¡µé¢åˆå§‹åŒ–ä¸æ¨¡å‹é€‰æ‹©

é¡µé¢çš„ä¸»ä½“åŒ…æ‹¬æœ¬é¡¹ç›®çš„æ ‡é¢˜ã€å®šä½ã€é€‰æ‹©ä½¿ç”¨çš„æ¨¡å‹ç­‰ã€‚æ¨¡å‹é€‰æ‹©åœ¨ä¾§è¾¹æ æä¾›æœåŠ¡ï¼Œç›®å‰æ”¯æŒ `qwen2.5:14b-instruct-fp16`ã€‚

- ä½¿ç”¨ `st.set_page_config()` è®¾ç½®é¡µé¢å±æ€§ï¼›
- å·¦ä¾§ä¾§è¾¹æ æä¾›æ¨¡å‹é€‰æ‹©å™¨ï¼ˆå½“å‰ä¸º qwen2.5:0.5bï¼‰ï¼›
- è‡ªåŠ¨æ ¹æ®æ¨¡å‹é€‰æ‹©ç»“æœé‡æ–°åˆå§‹åŒ– Agentã€‚

```python
st.markdown("<h1 class='main-title'>MedRAG </h1>", unsafe_allow_html=True)
    st.markdown(
        "<p class='subtitle'>ä½ çš„æ™ºèƒ½åŒ»ç–—AIé—®ç­”åŠ©æ‰‹ï½</p>",
        unsafe_allow_html=True,
    )

    model_options = {
        "qwen2.5-14b": "qwen2.5:14b-instruct-fp16",
        # "qwen2.5-0.5b": "qwen2.5:0.5b",
    }
    selected_model = st.sidebar.selectbox(
        "è¯·é€‰æ‹©ä½ éœ€è¦çš„æ¨¡å‹",
        options=list(model_options.keys()),
        index=0,
        key="model_selector",
    )
    model_id = model_options[selected_model]
```

### 2. Agent åˆå§‹åŒ–ä¸ä¼šè¯æ¢å¤
ä¸»æµç¨‹åŒ…æ‹¬ï¼šAgentåˆå§‹åŒ–ã€Agentä¼šè¯æ¢å¤ã€å†å²å¯¹è¯æ¢å¤

- è‹¥ Session ä¸­æ—  agent æˆ–æ¨¡å‹å˜åŠ¨ï¼Œåˆ™é€šè¿‡ `get_agent()` é‡æ–°åˆå§‹åŒ–ï¼›
- åˆ©ç”¨ `agent.load_session()` ä»å†…å­˜æˆ–æ•°æ®åº“ä¸­æ¢å¤ä¸Šä¸‹æ–‡è®°å¿†ã€‚

```python
 if (
        "agentic_rag_agent" not in st.session_state
        or st.session_state["agentic_rag_agent"] is None
        or st.session_state.get("current_model") != model_id
    ):
        logger.info("---*--- Creating new Agentic RAG  ---*---")
        agentic_rag_agent = get_agent()
        st.session_state["agentic_rag_agent"] = agentic_rag_agent
        st.session_state["current_model"] = model_id
    else:
        agentic_rag_agent = st.session_state["agentic_rag_agent"]

    if "chat_sessions" not in st.session_state:
        st.session_state["chat_sessions"] = {}
    if "current_session_name" not in st.session_state:
        st.session_state["current_session_name"] = f"ä¼šè¯{len(st.session_state['chat_sessions'])+1}"

    # æ£€æŸ¥ä¼šè¯IDæ˜¯å¦å·²å­˜åœ¨
    session_id_exists = (
        "agentic_rag_agent_session_id" in st.session_state
        and st.session_state["agentic_rag_agent_session_id"]
    )

    if not session_id_exists:
        try:
            st.session_state["agentic_rag_agent_session_id"] = (
                agentic_rag_agent.load_session()
            )
        except Exception as e:
            logger.error(f"Session load error: {str(e)}")
            st.warning("æ— æ³•åˆ›å»ºä¼šè¯ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œï¼")
    elif (
        st.session_state["agentic_rag_agent_session_id"]
        and hasattr(agentic_rag_agent, "memory")
        and agentic_rag_agent.memory is not None
        and not agentic_rag_agent.memory.runs
    ):
        try:
            agentic_rag_agent.load_session(
                st.session_state["agentic_rag_agent_session_id"]
            )
        except Exception as e:
            logger.error(f"Failed to load existing session: {str(e)}")

    agent_runs = []
    if hasattr(agentic_rag_agent, "memory") and agentic_rag_agent.memory is not None:
        agent_runs = agentic_rag_agent.memory.runs

    # åˆå§‹åŒ–ä¼šè¯
    if "messages" not in st.session_state:
        st.session_state["messages"] = []

    if len(st.session_state["messages"]) == 0 and len(agent_runs) > 0:
        logger.debug("Loading run history")
        for _run in agent_runs:
            # æ¶ˆæ¯
            if hasattr(_run, "message") and _run.message is not None:
                add_message(_run.message.role, _run.message.content)
            # å›ç­”
            if hasattr(_run, "response") and _run.response is not None:
                add_message("assistant", _run.response.content, _run.response.tools)
    elif len(agent_runs) == 0 and len(st.session_state["messages"]) == 0:
        logger.debug("No run history found")
```

### 3. ç”¨æˆ·è¾“å…¥ä¸æ¶ˆæ¯ç®¡ç†

ä¸»æµç¨‹åŒ…æ‹¬ï¼šæ”¯æŒç”¨æˆ·è¾“å…¥ä¸promptå¤„ç†

- `st.chat_input()` æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶ç«‹å³åŠ å…¥å†å²è®°å½•ï¼›
- æ‰€æœ‰ç”¨æˆ·ä¸åŠ©æ‰‹ä¿¡æ¯å­˜å…¥ `st.session_state["messages"]` å’Œæ•°æ®åº“ï¼›
- å¯¹è¯æ¶ˆæ¯æ”¯æŒå·¥å…·è°ƒç”¨å›æ˜¾ï¼ˆå¦‚æœç´¢ã€ç—…ä¾‹è°ƒå–ç­‰ï¼‰ã€‚

```python
 if prompt := st.chat_input("ğŸ‘‹ è¯·å°½æƒ…å‘æˆ‘æé—®ä»»ä½•å…³äºåŒ»ç–—çš„é—®é¢˜!"):
        add_message("user", prompt)

    if "loaded_urls" not in st.session_state:
        st.session_state.loaded_urls = set()
    if "loaded_files" not in st.session_state:
        st.session_state.loaded_files = set()
    if "knowledge_base_initialized" not in st.session_state:
        st.session_state.knowledge_base_initialized = False
```

### 4. åŒ»ç–—ç—…ä¾‹ç”Ÿæˆä¸ä¸‹è½½ï¼ˆä¾§è¾¹æ ï¼‰

ä¾§è¾¹æ åŒ…æ‹¬ï¼šæé—®ç¤ºä¾‹ï¼ˆæ€»ç»“å½“å‰ä¼šè¯çš„å…¨éƒ¨å†…å®¹ï¼Œé¢„è®¾çš„promptï¼‰ã€åˆ›å»ºæ–°èŠå¤©ï¼ˆé‡ç½®ä¼šè¯ï¼‰ã€å¯¼å‡ºèŠå¤©ï¼ˆä»¥markdownæ ¼å¼ï¼‰ã€ç”Ÿæˆç—…ä¾‹æŠ¥å‘Šï¼ˆè°ƒç”¨APIä¸‹è½½PDFæ–‡ä»¶ï¼‰ã€ä¼šè¯é€‰æ‹©ã€å†å²ä¼šè¯æ˜¾ç¤ºã€‚

- ç”¨æˆ·å¯ç‚¹å‡»ã€Œç”Ÿæˆç—…ä¾‹æŠ¥å‘Šã€æŒ‰é’®ï¼›
- å‰ç«¯å‘é€ POST è¯·æ±‚è‡³ `/generate_case_pdf`ï¼›
- æˆåŠŸåå¯é€šè¿‡ Streamlit çš„ `download_button()` ä¸‹è½½ PDF æŠ¥å‘Šã€‚

```python
st.sidebar.markdown("#### â“ æé—®ç¤ºä¾‹")
    if st.sidebar.button("ğŸ“ æ€»ç»“"):
        add_message(
            "user",
            "è¯·æ€»ç»“å½“å‰ä¼šè¯çš„å†…å®¹",
        )

    st.sidebar.markdown("#### ğŸ› ï¸ åŠŸèƒ½")
    if st.sidebar.button(
        "ğŸ”„ æ–°èŠå¤©", use_container_width=True
    ):
        restart_agent()
    if st.sidebar.download_button(
        "ğŸ’¾ å¯¼å‡ºèŠå¤©",
        export_chat_history(),
        file_name="rag_chat_history.md",
        mime="text/markdown",
        use_container_width=True,
    ):
        st.sidebar.success("èŠå¤©è®°å½•å·²å¯¼å‡º!")

    if "pdf_ready" not in st.session_state:
        st.session_state["pdf_ready"] = False
        st.session_state["pdf_bytes"] = None

    if st.sidebar.button("ğŸ“ƒ ç”Ÿæˆç—…ä¾‹æŠ¥å‘Š", use_container_width=True):
        with st.spinner("æ­£åœ¨ç”Ÿæˆç—…ä¾‹æŠ¥å‘Š..."):
            try:
                pdf_bytes = download_case()
                st.session_state["pdf_bytes"] = pdf_bytes
                st.session_state["pdf_ready"] = True
                st.sidebar.success("ç—…ä¾‹æŠ¥å‘Šå·²ç”Ÿæˆï¼")
            except Exception as e:
                st.session_state["pdf_ready"] = False
                st.sidebar.error(f"ç”Ÿæˆå¤±è´¥ï¼š{e}")

    # æŒ‰é’®2ï¼šä¸‹è½½ç—…ä¾‹æŠ¥å‘Šï¼ˆä»…åœ¨ç”ŸæˆæˆåŠŸåæ˜¾ç¤ºï¼‰
    if st.session_state["pdf_ready"]:
        st.sidebar.download_button(
            label="â¬‡ï¸ ä¸‹è½½ç—…ä¾‹æŠ¥å‘Š",
            data=st.session_state["pdf_bytes"],
            file_name="ç—…ä¾‹æŠ¥å‘Š.pdf",
            mime="application/pdf",
            use_container_width=True
        )

    for message in st.session_state["messages"]:
        if message["role"] in ["user", "assistant"]:
            _content = message["content"]
            if _content is not None:
                with st.chat_message(message["role"]):
                    if "tool_calls" in message and message["tool_calls"]:
                        display_tool_calls(st.empty(), message["tool_calls"])
                    st.markdown(_content)

    last_message = (
        st.session_state["messages"][-1] if st.session_state["messages"] else None
    )
    if last_message and last_message.get("role") == "user":
        question = last_message["content"]
        with st.chat_message("assistant"):
            tool_calls_container = st.empty()
            resp_container = st.empty()
            with st.spinner("ğŸ¤” æ€è€ƒä¸­..."):
                response = ""
                try:
                    run_response = agentic_rag_agent.run(question, stream=True)
                    for _resp_chunk in run_response:
                        if hasattr(_resp_chunk, "tool") and _resp_chunk.tool:
                            display_tool_calls(tool_calls_container, [_resp_chunk.tool])

                        if _resp_chunk.content is not None:
                            response += _resp_chunk.content
                            resp_container.markdown(response)

                    add_message(
                        "assistant", response, agentic_rag_agent.run_response.tools
                    )
                except Exception as e:
                    error_message = f"Sorry, I encountered an error: {str(e)}"
                    add_message("assistant", error_message)
                    st.error(error_message)
```

### 5. ä¼šè¯ç®¡ç†ä¸å†å²åˆ‡æ¢ï¼ˆä¾§è¾¹æ ï¼‰
- å½“å‰ Session å‘½åè§„èŒƒä¸º `session_001` ç­‰ï¼›
- æ”¯æŒç”¨æˆ·é‡å‘½åå½“å‰ä¼šè¯ï¼›
- ä¼šè¯å†å²å¯æµè§ˆä¸åˆ‡æ¢ï¼ˆä¿ç•™æ‰€æœ‰æ¶ˆæ¯å†…å®¹ï¼‰ï¼›
- æ”¯æŒèŠå¤©è®°å½•å¯¼å‡ºä¸º Markdown æ–‡ä»¶ã€‚

```python
# ä¼šè¯é€‰æ‹©
    session_selector_widget(agentic_rag_agent, model_id)
    rename_session_widget(agentic_rag_agent)
    
    st.sidebar.markdown("#### ğŸ’¬ å†å²ä¼šè¯")
    session_names = [i for i in list(st.session_state["chat_sessions"].keys())]
    with st.sidebar.container():
        for idx, name in enumerate(session_names):
            button_label = f"ğŸ‘‰ {name}" if name == st.session_state.get("current_session_name") else name
            if st.sidebar.button(button_label, key=f"session_{idx}"):
                # 1. ä¿å­˜å½“å‰ä¼šè¯ï¼ˆå¦‚æœæœ‰å†…å®¹ä¸”ä¸æ˜¯å½“å‰å†å²ä¼šè¯ï¼‰
                current_name = st.session_state.get("current_session_name")
                if (
                    st.session_state.get("messages")
                    and len(st.session_state["messages"]) > 0
                    and current_name is not None
                    and current_name not in st.session_state["chat_sessions"]
                ):
                    st.session_state["chat_sessions"][current_name] = st.session_state["messages"].copy()
                # 2. åˆ‡æ¢åˆ°ç›®æ ‡å†å²ä¼šè¯
                st.session_state["messages"] = st.session_state["chat_sessions"][name].copy()
                st.session_state["current_session_name"] = name
                st.rerun()
```

## å…³é”®å‡½æ•°è¯´æ˜

### `get_reader(file_type: str)`
è¿”å›å¯¹åº”æ–‡ä»¶ç±»å‹çš„ Reader å¯¹è±¡ï¼Œç”¨äºè¯»å–å¤–éƒ¨åŒ»ç–—èµ„æ–™æ–‡ä»¶ã€‚

### `download_case()`
å‘åç«¯ API è¯·æ±‚ PDF æ•°æ®å¹¶è¿”å›å­—èŠ‚æµï¼Œç”¨äºç—…ä¾‹ç”ŸæˆåŠŸèƒ½ã€‚

### `main()`
åº”ç”¨ç¨‹åºä¸»å…¥å£ï¼Œç»„ç»‡ UIã€æ¨¡å‹ã€èŠå¤©äº¤äº’ã€ç—…ä¾‹ç”ŸæˆåŠŸèƒ½çš„æ•´ä½“é€»è¾‘ã€‚

## çŠ¶æ€ç®¡ç†ï¼ˆst.session_stateï¼‰

| å˜é‡å | è¯´æ˜ |
|--------|------|
| `agentic_rag_agent` | å½“å‰å¯¹è¯çš„ Agent å®ä¾‹ |
| `current_model` | å½“å‰ä½¿ç”¨çš„æ¨¡å‹åç§° |
| `messages` | å½“å‰ä¼šè¯çš„æ¶ˆæ¯å†å² |
| `chat_sessions` | æ‰€æœ‰å†å²ä¼šè¯æ•°æ® |
| `current_session_name` | å½“å‰æ´»è·ƒçš„ä¼šè¯åç§° |
| `pdf_ready` | æ˜¯å¦æˆåŠŸç”Ÿæˆç—…ä¾‹ PDF |
| `pdf_bytes` | å·²ç”Ÿæˆçš„ç—…ä¾‹æŠ¥å‘ŠäºŒè¿›åˆ¶æ•°æ® |
| `agentic_rag_agent_session_id` | å½“å‰ Agent çš„æŒä¹…åŒ– session id |

##  å¾…ä¼˜åŒ–ç‚¹ä¸åç»­å¼€å‘è®¡åˆ’

æœ€å¥½å®ç°å¤šæ¨¡å‹ï¼ˆå¦‚ llama, qwen2.5-14bï¼‰åˆ‡æ¢æ¥åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ”¯æŒæ–‡ä»¶ä¸Šä¼ å€Ÿå£ï¼Œå®ç°è‡ªå®šä¹‰åŒ»å­¦æ–‡æ¡£å¯¹è¯ç­‰
